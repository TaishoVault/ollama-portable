name: Download and Repackage Ollama

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * *' # Check daily

permissions:
  contents: write

jobs:
  check-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download OllamaSetup.exe
        run: Invoke-WebRequest -Uri "https://ollama.com/download/OllamaSetup.exe" -OutFile "OllamaSetup.exe"

      - name: Check for Updates
        id: check_update
        run: |
          $hash = (Get-FileHash "OllamaSetup.exe" -Algorithm MD5).Hash
          Write-Host "Current Hash: $hash"
          
          $prevHash = ""
          if (Test-Path "ollama.md5") {
            $prevHash = Get-Content "ollama.md5"
            Write-Host "Previous Hash: $prevHash"
          }

          if ($hash -ne $prevHash) {
            Write-Host "Update detected!"
            echo "NEEDS_UPDATE=true" >> $env:GITHUB_ENV
            echo "NEW_HASH=$hash" >> $env:GITHUB_ENV
          } else {
            Write-Host "No update necessary."
            echo "NEEDS_UPDATE=false" >> $env:GITHUB_ENV
          }

      - name: Extract Ollama
        if: env.NEEDS_UPDATE == 'true'
        shell: cmd
        run: |
          echo Extracting to %CD%\ollama...
          OllamaSetup.exe /DIR="%CD%\ollama" /VERYSILENT /NORESTART /SP- /SUPPRESSMSGBOXES
          
          REM Wait for installer to finish since we are not using start /wait
          :loop
          timeout /t 2 >nul
          tasklist /fi "imagename eq OllamaSetup.exe" | find "OllamaSetup.exe" >nul
          if %ERRORLEVEL%==0 goto loop
          
          echo Extraction complete.
          dir "%CD%\ollama"

      - name: Get Version
        if: env.NEEDS_UPDATE == 'true'
        id: get_version
        run: |
          $verOutput = & .\ollama\ollama.exe --version 2>&1 | Out-String
          Write-Host "Version output: $verOutput"
          if ($verOutput -match "(\d+\.\d+\.\d+)") {
            $version = $matches[1]
            Write-Host "Detected Version: $version"
            echo "VERSION=$version" >> $env:GITHUB_ENV
          } else {
            Write-Error "Could not detect version"
            exit 1
          }

      - name: Prepare Redist and Zips
        if: env.NEEDS_UPDATE == 'true'
        run: |
          # Copy portable script
          Copy-Item -Path "ollama_portable.bat" -Destination "ollama\ollama_portable.bat"
          
          # Create redist structure
          New-Item -ItemType Directory -Force -Path "redist"
          
          # Move lib
          if (Test-Path "ollama\lib") {
            Move-Item -Path "ollama\lib" -Destination "redist\lib"
          }
          
          # Compress using 7z to handle large files (splitting if needed, but here we just use max compression)
          # GitHub release asset limit is 2GB. If it exceeds, we need to split.
          # For now, let's try 7z with best compression to see if it fits, otherwise we split.
          
          # Compress ollama main folder
          7z a -tzip -mx9 "ollama-$env:VERSION.zip" "ollama\*"
          
          # Compress redist folder - using 7z format might be better but let's stick to zip for compatibility unless size is issue
          # The error says size > 2GB. 
          # Let's use 7z to create a multi-part archive if it's too big, OR just use 7z format which has better compression.
          # BUT standard windows zip doesn't support multi-part well.
          # Let's split into 1GB chunks.
          
          7z a -tzip -mx9 -v1000m "redist.zip" "redist\*"

      - name: Create Release
        if: env.NEEDS_UPDATE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get list of files to upload (redist.zip.001, etc or just redist.zip)
          $assets = Get-ChildItem "ollama-$env:VERSION.zip", "redist.zip*" | Select-Object -ExpandProperty Name
          $assetsString = $assets -join " "
          Write-Host "Uploading assets: $assetsString"
          
          # gh release create expects each file as a separate arg
          # We can't pass a string with spaces directly in the way powershell handles args sometimes
          # Let's run it via cmd/bash or construct the command string
          
          $cmd = "gh release create ""v$env:VERSION"" $assetsString --title ""Ollama v$env:VERSION"" --notes ""Automated build from OllamaSetup.exe"""
          Invoke-Expression $cmd

      - name: Update MD5 Tracking
        if: env.NEEDS_UPDATE == 'true'
        run: |
          $env:NEW_HASH | Out-File "ollama.md5" -NoNewline -Encoding ascii
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ollama.md5
          git commit -m "Update ollama.md5 to $env:NEW_HASH [skip ci]"
          git push
