name: Download and Repackage Ollama

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  repackage:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download OllamaSetup.exe
        run: Invoke-WebRequest -Uri "https://ollama.com/download/OllamaSetup.exe" -OutFile "OllamaSetup.exe"

      - name: Extract Ollama
        run: |
          Write-Host "Extracting to $pwd\ollama..."
          Start-Process -FilePath ".\OllamaSetup.exe" -ArgumentList "/DIR=$pwd\ollama", "/VERYSILENT", "/NORESTART" -Wait
          ls $pwd\ollama

      - name: Get Version
        id: get_version
        run: |
          $verOutput = & .\ollama\ollama.exe version
          Write-Host "Version output: $verOutput"
          # Parsing "ollama version is 0.1.27" or similar
          if ($verOutput -match "(\d+\.\d+\.\d+)") {
            $version = $matches[1]
            Write-Host "Detected Version: $version"
            echo "VERSION=$version" >> $env:GITHUB_ENV
          } else {
            Write-Error "Could not detect version"
            exit 1
          }

      - name: Prepare Redist and Zips
        run: |
          # Create redist structure
          New-Item -ItemType Directory -Force -Path "redist"
          
          # Move lib
          if (Test-Path "ollama\lib") {
            Move-Item -Path "ollama\lib" -Destination "redist\lib"
          } else {
            Write-Warning "ollama\lib folder not found. Skipping move."
          }
          
          # Create Zips
          # redist.zip
          Compress-Archive -Path "redist" -DestinationPath "redist.zip"
          
          # ollama-{version}.zip
          Compress-Archive -Path "ollama" -DestinationPath "ollama-$env:VERSION.zip"

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v$env:VERSION" "ollama-$env:VERSION.zip" "redist.zip" --title "Ollama v$env:VERSION" --notes "Automated build from OllamaSetup.exe"
